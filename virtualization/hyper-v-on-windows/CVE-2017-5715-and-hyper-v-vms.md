# <a name="protecting-guest-virtual-machines-from-cve-2017-5715-branch-target-injection"></a>Protección de las máquinas virtuales invitadas frente a CVE-2017-5715 (inserción de destino de bifurcación)

En esta página se ofrece información adicional sobre cómo proteger las máquinas virtuales en hosts de Hyper-V frente a CVE-2017-5715 (inserción de destino de bifurcación).  Para obtener instrucciones generales sobre WindowsServer, consulta [esta página](https://support.microsoft.com/en-us/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution).

Debes realizar los siguientes pasos para garantizar la protección de las máquinas virtuales:

1. Actualizar el sistema operativo del host.
2. Asegurarse de que el host de virtualización se ha actualizado al firmware que incluye las actualizaciones de CVE-2017-5715.
3. Asegurarse de que Hyper-V está configurado para mostrar las nuevas funcionalidades del procesador a las máquinas virtuales invitadas.
4. Actualizar el sistema operativo invitado según sea necesario. 
5. Realizar un arranque en frío de las máquinas virtuales invitadas.

## <a name="update-the-host-operating-system"></a>Actualizar el sistema operativo del host

Aplica la actualización del sistema operativo Windows al host de virtualización. Para obtener más información sobre cómo habilitar esta actualización, consulta el [Artículo 4072699 de MicrosoftKnowledgeBase](https://support.microsoft.com/help/4072699).

## <a name="ensure-the-virtualization-host-has-been-updated-to-firmware-which-contains-updates-for-cve-2017-5715"></a>Asegurarse de que el host de virtualización se ha actualizado al firmware que incluye las actualizaciones de CVE-2017-5715

Las actualizaciones de firmware de tu OEM pueden incluir nuevas funcionalidades del procesador que pueden usarse para protegerse frente a CVE-2017-5715 ([IBRS, STIBP, IBPB](https://newsroom.intel.com/wp-content/uploads/sites/11/2018/01/Intel-Analysis-of-Speculative-Execution-Side-Channels.pdf)).  Una vez que el firmware del host de virtualización se ha actualizado, el hipervisor puede poner a disposición de las máquinas virtuales invitadas estas funcionalidades adicionales después de realizar los siguientes pasos.

## <a name="ensure-hyper-v-is-configured-to-expose-new-processor-capabilities-to-guest-virtual-machines"></a>Asegurarse de que Hyper-V está configurado para mostrar las nuevas funcionalidades del procesador a las máquinas virtuales invitadas.

Asegúrate de que Hyper-V está configurado para mostrar las nuevas funcionalidades del procesador en las máquinas virtuales invitadas.  Esta configuración se basa en la [Versión de la máquina virtual](https://docs.microsoft.com/en-us/windows-server/virtualization/hyper-v/deploy/upgrade-virtual-machine-version-in-hyper-v-on-windows-or-windows-server) de las máquinas virtuales invitadas. 

Si la versión de todas las máquinas virtuales en el host es la versión 8.0 o superior, no se necesita realizar ninguna configuración.  Estas máquinas virtuales verán las nuevas funcionalidades del procesador después de un arranque en frío.

Si hay alguna máquina virtual con una versión inferior a 8.0, debes establecer un valor del Registro específico en el sistema operativo del host.  Esto configurará Hyper-V para mostrar las nuevas funcionalidades del procesador en las máquinas virtuales invitadas con versiones de VM inferiores.

El valor del Registro es `MinVmVersionForCpuBasedMitigations` en `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization`.  El valor debe establecerse en la versión mínima de máquina virtual que necesita acceso a las funcionalidades de firmware actualizado, en el formato "Major.Minor".  Para mostrar el firmware a todas las máquinas virtuales en el host (es decir, versión 1.0 y superior), ejecuta el siguiente comando en el host: 

```
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization" /v MinVmVersionForCpuBasedMitigations /t REG_SZ /d "1.0" /f
```
*Nota: La versión 8.0 de máquina virtual se incluyó en WindowsServer2016 y en la Actualización de aniversario de Windows10.  Los hosts que ejecutan WindowsServer2012R2 y versiones inferiores deben establecer el valor del Registro*

*Advertencia: Se producirá un error en la migración en vivo entre los hosts con el firmware actualizado y los hosts sin el firmware actualizado.  Para obtener más información, consulta las Preguntas más frecuentes en la parte inferior de este documento.*

## <a name="optional-configure-pre-skylake-intel-systems-to-use-retpoline"></a>*Opcional*: configurar los sistemas de Intel _pre-Skylake_ para usar Retpoline

*Advertencia: configurar máquinas virtuales en hosts de Intel pre-Skylake para Retpoline bloqueará la migración en vivo a hosts más recientes (es decir, Skylake y posteriores).*

De manera predeterminada, las máquinas virtuales que se ejecutan en sistemas de pre-Skylake no pueden usar retpoline.  Para permitir que estos sistemas sacar provecho de las mitigaciones en función de retpoline, establece `RetsPredictedFromRsbOnly` en `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization` a `1`. 

```
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization" /v RetsPredictedFromRsbOnly /t REG_DWORD /d 1 /f
```

Para invertir esta configuración (es decir, impedir que las máquinas virtuales aprovechando retpoline), establece `RetsPredictedFromRsbOnly` a `0`.

## <a name="update-the-guest-operating-system"></a>Actualizar el sistema operativo invitado

Para completar la protección frente a CVE-2017-5715 en estas máquinas virtuales, el sistema operativo invitado debe actualizarse y configurarse para sacar partido de estas nuevas funcionalidades.  En el caso de sistemas operativos de Microsoft, sigue las instrucciones indicadas en [este artículo](https://support.microsoft.com/en-us/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution) al realizar la actualización.

*Nota: La actualización del sistema operativo invitado puede producirse en cualquier momento durante este proceso.  Puede producirse antes de actualizar el firmware del host o después de arrancar en frío la máquina virtual invitada.*

## <a name="perform-a-cold-boot-of-the-guest"></a>Realizar un arranque en frío de las máquinas virtuales invitadas

Después de completar los tres primeros pasos, las máquinas virtuales deben someterse a un arranque en frío para ver las nuevas funcionalidades del procesador.  Esto significa que las máquinas virtuales en ejecución deben apagarse por completo antes de iniciarse de nuevo.  Reiniciar desde el sistema operativo invitado no es suficiente.

## <a name="frequently-asked-questions"></a>Preguntas más frecuentes

### <a name="how-does-this-impact-live-migration"></a>¿Cómo afecta esto a la migración en vivo?

Se producirá un error en la migración en vivo de una máquina virtual con las nuevas funcionalidades del procesador al migrar a hosts de Hyper-V sin el firmware actualizado.  Para habilitar la migración en vivo a un host sin el firmware actualizado, deja de mostrar las funcionalidades actualizadas del procesador en dicha máquina virtual invitada.  La forma más sencilla es modificar `MinVmVersionForCpuBasedMitigations` a una versión de máquina virtual (VM) superior a la de la máquina virtual que necesita migrar y realizar un arranque en frío de dicha máquina virtual.

La migración de máquinas virtuales sin las nuevas funcionalidades del procesador se realizará correctamente al migrar a hosts de Hyper-V con el firmware actualizado.  Sin embargo, es necesario realizar un arranque en frío para que estas máquinas virtuales invitadas vean las funcionalidades de firmware actualizadas.

Se producirá un error de máquinas virtuales configuradas para usar Retpoline en sistemas de Intel pre-Skylake migrar a nuevas familias de procesador (es decir, Skylake y versiones posteriores).

### <a name="what-about-live-migration-of-version-50-virtual-machines-between-windows-server-2012r2-and-windows-server-2016"></a>¿Qué sucede con la migración en vivo de las máquinas virtuales con la versión 5.0 entre WindowsServer2012R2 y WindowsServer2016?
Para garantizar una migración correcta en este escenario, el valor del Registro debe establecerse tanto en el sistema WindowsServer2012R2 como en el sistema WindowsServer2016.  Después de migrar a WindowsServer2016, la versión de la máquina virtual seguirá siendo 5.0 y, por tanto, se necesita la clave de registro para mostrar las nuevas funcionalidades del procesador a la máquina virtual.  

### <a name="does-this-guidance-apply-to-virtual-machines-running-on-vmware"></a>¿Estas instrucciones se aplican a las máquinas virtuales que se ejecutan en VMWare?
No, estas instrucciones están destinadas específicamente a las máquinas virtuales que se ejecutan en hosts de Hyper-V.

### <a name="does-this-guidance-apply-to-hyper-v-on-windows-10"></a>¿Estas instrucciones se aplican a Hyper-V en Windows10?
Sí, se aplican los mismos pasos a las máquinas virtuales que se ejecutan tanto en WindowsServer como en Client.

### <a name="do-i-need-to-install-the-firmware-updates-before-performing-a-cold-boot-of-the-virtual-machines"></a>¿Necesito instalar las actualizaciones de firmware antes de realizar un arranque en frío de las máquinas virtuales?
Sí, debes actualizar el firmware y sistema operativo del host antes de realizar un arranque en frío de las máquinas virtuales.

### <a name="what-can-i-do-if-my-oem-does-not-yet-provide-an-updated-firmware"></a>¿Qué puedo hacer si mi OEM no ofrece aún un firmware actualizado?
Echa un vistazo a [Protecciones alternativas para hosts de Hyper-V de WindowsServer2016 frente a vulnerabilidades de canal lateral de ejecución especulativa](https://docs.microsoft.com/en-us/virtualization/hyper-v-on-windows/CVE-2017-5715-and-hyper-v-hosts)

### <a name="how-do-i-check-the-vm-version-for-my-virtual-machines"></a>¿Cómo compruebo la versión de mis máquinas virtuales?
Ejecuta el siguiente PowerShell en el host de Hyper-V:
``` PowerShell
Get-VM * | Format-Table Name, Version  
```

### <a name="do-i-need-to-do-something-different-to-protect-virtual-machines-running-under-processor-compatibility-mode"></a>¿Necesito hacer algo diferente para proteger las máquinas virtuales que se ejecutan en el "Modo de compatibilidad de procesador"?
No.  Después de seguir las instrucciones de esta página, las nuevas funcionalidades del procesador también se mostrarán a las máquinas virtuales que se inicien en el modo de compatibilidad de procesador.

### <a name="what-if-only-half-of-the-machines-in-my-cluster-have-received-a-firmware-update"></a>¿Qué ocurre si solo la mitad de las máquinas de mi clúster han recibido una actualización de firmware?
Esto afectará a la migración en vivo en el clúster.  Las máquinas virtuales con las nuevas funcionalidades del procesador ya no podrán migrar en vivo a hosts sin la actualización de firmware.  

### <a name="how-can-i-validate-that-the-guest-virtual-machine-has-access-to-the-new-processor-features"></a>¿Cómo puedo comprobar que la máquina virtual invitada tiene acceso a las nuevas características del procesador?
Usa el módulo/script de PowerShell "control de especulación".  Consulta [esta página](https://support.microsoft.com/en-us/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution) para obtener instrucciones detalladas.

